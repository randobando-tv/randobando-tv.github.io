<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>AR — A-Frame 1.7.0 + MindAR (boilerplate)</title>

  <!-- A-Frame 1.7.0 -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- MindAR (A-Frame integration) -->
  <!-- Versão prod com integração A-Frame; mantém API simples por <script>. -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html,body{margin:0;height:100%;background:transparent;overflow:hidden;}
    /* Overlay de instruções (DOM overlay opcional) */
    #hud{
      position:fixed;left:0;top:0;right:0;padding:12px 16px;
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.8);
      display:flex; justify-content:space-between; pointer-events:none;
    }
    #hint{opacity:.85}
  </style>
</head>
<body>
  <div id="hud">
    <div id="hint">Aponte para o alvo. Toque para iniciar a animação.</div>
    <div id="status"></div>
  </div>

  <!-- Cena A-Frame com MindAR -->
  <a-scene
    mindar-image="imageTargetSrc: assets/target.mind; filterMinCF: 0.001; filterBeta: 0.02;"
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true, alpha: true, antialias: true"
    embedded
    device-orientation-permission-ui="enabled: true">

    <!-- Assets (placeholder de uma única imagem para o 1º frame) -->
    <a-assets timeout="15000">
      <img id="firstFrame" src="assets/anim1/anim1_0001.png" crossorigin="anonymous"/>
    </a-assets>

    <!-- Câmera do MindAR -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Âncora: tudo aqui segue o alvo detectado -->
    <a-entity mindar-image-target="targetIndex: 0" id="anchor">

      <!-- Personagem (primeiro frame) - aparece ao detectar o alvo -->
      <a-image id="sprite"
               src="#firstFrame"
               position="0 0 0"
               rotation="0 0 0"
               transparent="true"
               alpha-test="0.01"
               width="1.2" height="1.2"
               visible="false">
      </a-image>

      <!-- Botões (invisíveis até o keep-alive iniciar) -->
      <a-entity id="buttons" visible="false" position="0 0.05 0" rotation="0 0 0">
        <!-- Botão 1 -->
        <a-plane class="btn" position="-0.5 0 0" width="0.4" height="0.15" color="#222" opacity="0.8">
          <a-text value="Site A" align="center" width="1.2" position="0 0 0.01"></a-text>
        </a-plane>
        <!-- Botão 2 -->
        <a-plane class="btn" position="0 0 0" width="0.4" height="0.15" color="#222" opacity="0.8">
          <a-text value="Site B" align="center" width="1.2" position="0 0 0.01"></a-text>
        </a-plane>
        <!-- Botão 3 -->
        <a-plane class="btn" position="0.5 0 0" width="0.4" height="0.15" color="#222" opacity="0.8">
          <a-text value="Site C" align="center" width="1.2" position="0 0 0.01"></a-text>
        </a-plane>
      </a-entity>

    </a-entity>
  </a-scene>

  <script>
    // --------- Configuração da sequência PNG ----------
    // Ajuste os padrões de nomes/conteúdo aqui conforme seus arquivos.
    const ANIM1 = {
      folder: 'assets/anim1',
      pattern: i => `anim1_${String(i).padStart(4,'0')}.png`,
      start: 1, end: 6, fps: 10
    };
    const KEEP = {
      folder: 'assets/keepalive',
      pattern: i => `keep_${String(i).padStart(4,'0')}.png`,
      start: 1, end: 6, fps: 6, loop: true
    };

    // Estado simples
    let detected = false;
    let playing = false;
    let keepAlive = false;
    let frameTimer = null;
    let currentFrame = 1;
    let currentAnim = null;

    const $ = sel => document.querySelector(sel);
    const sprite = $('#sprite');
    const buttons = $('#buttons');
    const statusEl = $('#status');

    // Pré-carrega uma sequência (para reduzir piscadas em mobile)
    async function preloadSequence(cfg){
      const promises = [];
      for (let i = cfg.start; i <= cfg.end; i++){
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = `${cfg.folder}/${cfg.pattern(i)}`;
        promises.push(new Promise(res => { img.onload = res; img.onerror = res; }));
      }
      await Promise.all(promises);
    }

    // Reproduz a sequência trocando o material.src do a-image
    function playSequence(cfg, onEnd){
      stopSequence();
      currentAnim = cfg;
      currentFrame = cfg.start;
      const interval = 1000 / (cfg.fps || 10);
      frameTimer = setInterval(() => {
        const src = `${cfg.folder}/${cfg.pattern(currentFrame)}`;
        sprite.setAttribute('src', src);
        currentFrame++;
        if (currentFrame > cfg.end){
          if (cfg.loop){
            currentFrame = cfg.start;
          } else {
            stopSequence();
            if (onEnd) onEnd();
          }
        }
      }, interval);
    }
    function stopSequence(){
      if (frameTimer){ clearInterval(frameTimer); frameTimer = null; }
    }

    // Eventos MindAR (detecção do alvo)
    const anchor = document.getElementById('anchor');
    anchor.addEventListener('targetFound', async () => {
      detected = true;
      statusEl.textContent = 'Alvo detectado';
      // Mostrar primeiro frame “parado”
      sprite.setAttribute('visible', 'true');
      buttons.setAttribute('visible', 'false');
      keepAlive = false;
      playing = false;

      // Pré-carregar (não bloqueia a UI)
      preloadSequence(ANIM1);
      preloadSequence(KEEP);
    });
    anchor.addEventListener('targetLost', () => {
      detected = false;
      statusEl.textContent = 'Procurando alvo...';
      sprite.setAttribute('visible', 'false');
      buttons.setAttribute('visible', 'false');
      stopSequence();
      keepAlive = false;
      playing = false;
    });

    // Toque em qualquer lugar da tela -> inicia Animação 1 (se alvo presente)
    document.body.addEventListener('click', () => {
      if (!detected) return;
      if (playing || keepAlive) return;
      playing = true;
      playSequence(ANIM1, () => {
        // Termina anim1 -> entra keep-alive em loop + mostra botões
        keepAlive = true;
        playing = false;
        playSequence(KEEP);
        buttons.setAttribute('visible', 'true');
      });
    });

    // Clique dos botões (abre links). Em iOS, precisa ser gesto do usuário (ok).
    const btns = document.querySelectorAll('.btn');
    const links = ['https://randobando.tv/','https://www.instagram.com/randobando.tv/','https://www.behance.net/randobando'];
    btns.forEach((el, idx) => {
      el.addEventListener('click', (e) => {
        e.stopPropagation(); // evita re-disparar o click do body
        const url = links[idx];
        window.open(url, '_blank', 'noreferrer');
      });
    });
  </script>
</body>
</html>
